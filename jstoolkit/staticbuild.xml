<!-- This file was an attempt to pull all dependency management out of require statements and into ant.  
Although it was **mostly working** I regard it as a failure, as there was too much complexity in the concatination of the javascript files
to make a 100% ant solution with no custom ant task viable -->

<?xml version="1.0"?>
<project default="build">

	<property name="version" value="1.0"/>
	<property name="yui-compressor.jar"  location="lib/yuicompressor-2.4.2.jar" />
	<property name="yui-compressor-ant-task.jar" location="lib/yui-compressor-ant-task-0.4.jar" />

	<path id="task.classpath">
	  <pathelement location="lib/yuicompressor-2.4.2.jar" />
	  <pathelement location="lib/rhino-1.6R7.jar" />
	  <pathelement location="lib/jargs-1.0.jar" />
	  <pathelement location="lib/jscompiler.jar"/>
	</path>
	
	<taskdef name="jscompiler" classpath="lib/jscompiler.jar" classname="com.crowdfactory.js.JSCompiler"/>
	<taskdef name='yui-compress' classpathref="task.classpath" classname="com.crowdfactory.js.YUICompress"/>

	<property name="srcDir" value="${basedir}/src"></property>
	<property name='buildDir' value="${basedir}/build/js/" />
	
	<property name="coreSrcDir" value="${srcDir}/core"/>
	<filelist id="coreOrder" dir="${coreSrcDir}">
	 	<file name="CF.js"/>
	</filelist>

	<property name="transportSrcDir" value="${srcDir}/transport"/>
	<filelist id="transportOrder" dir="${transportSrcDir}">
	 	<file name="CF.RestV1.js"/>
		<file name="CF.iframe.frameCount.js"/>
		<file name="CF.iframe.IframeUploadComm.js"/>
	</filelist>
	
	<property name="supportSrcDir" value="${srcDir}/support"/>
	<filelist id="supportOrder" dir="${supportSrcDir}">
		<file name="CF.cookie.js"/>
		<file name="CF.date.js"/>
		<file name="CF.session.js"/>
		<file name="CF.context.js"/>
		<file name="CF.login.js"/>
		<file name="CF.template.js"/>
	</filelist>	
		
	<property name="widgetSrcDir" value="${srcDir}/widget"/>
	
	<filelist id="widgetOrder" dir="${widgetSrcDir}" files="">
		<file name="CF.widget.js"/>
		<file name="CF.widget.SimpleWidget.js"/>
		<file name="CF.widget.BaseComments.js"/>
		<file name="CF.widget.UserRating.js"/>
		<file name="CF.widget.EntityRating.js"/>
		<file name="CF.widget.CrowdList.js"/>
	</filelist>	
	
	<target name='buildFolders'>
		<mkdir dir="${basedir}/build"/>
		<mkdir dir="${buildDir}"/>
	</target>
	
	<target name='clean'>
		<delete dir="${buildDir}" />
	</target>
	
	<target name="core" depends='buildFolders'>
		<delete file="${buildDir}/CF_core.js" />
		<concat destfile="${buildDir}/CF_core.js">
			<filelist refid="coreOrder"></filelist>
		</concat>
		<concat destfile="${buildDir}/CF_core.js">
			<fileset dir="${coreSrcDir}">
				<include name="*.js" />
				<exclude>
					
				</exclude>
			</fileset>
		</concat>
		<antcall target="increment"></antcall>
	</target>

	<target name="increment">
	  <propertyfile file="version.properties" comment="Build version info">
		    <entry key="buildDate" type="date" value="now"/>
		    <entry key="buildNum" default="0" type="int" operation="+" value="1"/>
	  </propertyfile>
	  <replace
	        file="${buildDir}/CF_core.js"
	        value="value not found in version.properties"
	        propertyFile="version.properties">
	        <replacefilter token="@CF.buildDate@" property="buildDate"/>
	        <replacefilter token="@CF.buildNum@" property="buildNum"/>
	  		<replacefilter token="@CF.version@" property="version"/>
	    </replace>
	</target>
	
	<target name='transport' depends ='core'>
		<delete file="${buildDir}/CF_transport.js" />
		<concat destfile="${buildDir}/CF_transport.js">

		</concat>	
	</target>

	<target name='support' depends ='transport'>
		<delete file="${buildDir}/CF_support.js" />
		<concat destfile="${buildDir}/CF_support.js">
	
		</concat>
		<concat append="true" destfile="${buildDir}/CF_support.js">
			<fileset dir="${supportSrcDir}" >
				<include name="*.js"  />
			</fileset>
		</concat>
	</target>
			
	<target name='widget' depends ='support'>
		<delete file="${buildDir}/CF_widget.js" />

		
		<concat destfile="${buildDir}/CF_widget.js">
			
		</concat>	
		<concat append="true" destfile="${buildDir}/CF_widget.js">
			<fileset dir="${widgetSrcDir}">
				<include name="*.js"/>
				<exclude id=
			</fileset>
		</concat>
	</target>
		
	<target name="compile" depends='clean,widget'>
		
		<concat destfile="${buildDir}/CF_full.js">
			<filelist dir="${buildDir}" >
				<file name="CF_core.js"/>
				<file name="CF_transport.js"/>
				<file name="CF_support.js"/>
				<file name="CF_widget.js"/>
			</filelist>
		</concat>
		
		<concat destfile="${buildDir}/CF_rest.js">
			<filelist dir="${buildDir}" >
				<file name="CF_core.js"/>
				<file name="CF_transport.js"/>
			</filelist>
		</concat>
		
		<!-- Delete intermediate build products  -->
		<delete>
			<filelist dir="${buildDir}">
				<file name="CF_core.js"/>
				<file name="CF_transport.js"/>
				<file name="CF_support.js" />
				<file name="CF_widget.js" />
			</filelist>
		</delete>		
	</target>
	
	<target name="compress">
		<copy file="${buildDir}/CF_full.js" tofile="${buildDir}/CF_full_min.js"/>
		<copy file="${buildDir}/CF_rest.js" tofile="${buildDir}/CF_rest_min.js"/>
	  	
		<yui-compress src="${buildDir}/CF_full.js" linebreak="0" dest="${buildDir}/CF_full_min.js" /> 
		<yui-compress src="${buildDir}/CF_rest.js" linebreak="0" dest="${buildDir}/CF_rest_min.js" />
	  	
		<gzip src="${basedir}/build/js/CF_full_min.js" destfile="${basedir}/build/js/CF_full_min.js.gz" />
		<gzip src="${basedir}/build/js/CF_rest_min.js" destfile="${basedir}/build/js/CF_rest_min.js.gz" />
	</target>
	
	<target name="build" depends="compile,compress">
	</target>
	
</project>